<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Presupuestador p√©rgola bioclim√°tica - Galisur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0054a6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <!-- Librer√≠as jsPDF para generaci√≥n de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ============================================
       VARIABLES Y RESET
       ============================================ */
    :root {
      --blue-main: #0054a6;
      --blue-dark: #003b7a;
      --blue-soft: #e6f0fb;
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --border: #d1d9e6;
      --border-subtle: #d7deea;
      --primary-color: var(--blue-main);
      --text: #0f172a;
      --text-soft: #4b5563;
      --danger: #b91c1c;
      --radius: 0.9rem;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #e3edff, #f5f7fb 40%);
      color: var(--text);
    }

    /* ============================================
       LAYOUT PRINCIPAL
       ============================================ */
    .app {
      max-width: 1200px;
      margin: 0 auto 2rem;
      background: transparent;
    }

    .page-title-block {
      padding: 0.8rem 1.5rem 0.4rem;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }

    h1 {
      margin: 0;
      font-size: 1.45rem;
      color: var(--blue-dark);
    }

    .subtitle {
      margin: 0.25rem 0 0;
      color: var(--text-soft);
      font-size: 0.9rem;
    }

    .version-pill {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #ffffffd9;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--text-soft);
    }

    .version-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #16a34a;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.3fr);
      gap: 1.25rem;
      padding: 0.4rem 1.5rem 0;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
        padding: 0.4rem 0.9rem 0;
      }
    }

    /* ============================================
       TARJETAS Y COMPONENTES
       ============================================ */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
      padding: 1.1rem 1.25rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.9rem;
      gap: 0.75rem;
    }

    .card-title {
      font-size: 1.02rem;
      font-weight: 600;
      color: var(--blue-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .step-badge {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: var(--blue-soft);
      color: var(--blue-main);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: var(--blue-soft);
      color: var(--blue-main);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ============================================
       DATOS GENERALES PRESUPUESTO
       ============================================ */
    .datos-presupuesto {
      padding: 0 1.5rem 0.4rem;
    }

    .datos-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.7rem;
    }

    @media (max-width: 900px) {
      .datos-presupuesto {
        padding: 0 0.9rem 0.4rem;
      }
      .datos-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* ============================================
       FORMULARIOS Y CAMPOS
       ============================================ */
    .grid {
      display: grid;
      gap: 0.65rem 1rem;
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 800px) {
      .grid-2,
      .grid-3 {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 0.15rem;
      font-weight: 600;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      font-size: 0.86rem;
      background: #f9fafb;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }


    /* Ocultar flechas (spinners) de inputs num√©ricos */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    input::placeholder {
      color: #9ca3af;
    }

    input:focus,
    select:focus {
      border-color: var(--blue-main);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .field-note {
      font-size: 0.74rem;
      color: var(--text-soft);
      margin-top: 0.15rem;
    }

    .field-error {
      font-size: 0.75rem;
      color: var(--danger);
      margin-top: 0.1rem;
    }

    .inline-checkbox {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.2rem;
    }

    .inline-checkbox input[type="checkbox"] {
      width: 15px;
      height: 15px;
    }

    /* ============================================
       PILL OPTIONS (RADIO BUTTONS)
       ============================================ */
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .pill-option {
      position: relative;
    }

    .pill-option input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .pill-option span {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.78rem;
      background: #f9fafb;
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.15s;
    }

    .pill-option input:checked + span {
      background: var(--blue-main);
      color: #fff;
      border-color: var(--blue-main);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.5);
    }

    /* ============================================
       NOTAS Y AVISOS
       ============================================ */
    .note {
      margin-top: 0.55rem;
      padding: 0.45rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px dashed #cbd5f1;
      background: #f3f6ff;
      font-size: 0.72rem;
      color: var(--text-soft);
      display: flex;
      gap: 0.35rem;
      align-items: flex-start;
    }

    .note strong {
      color: var(--blue-dark);
    }

    .note-icon {
      font-size: 0.9rem;
      line-height: 1;
    }

    .warning {
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: var(--danger);
    }

    .aviso-amarillo {
      margin-top: 0.4rem;
      padding: 0.55rem 0.65rem;
      border-radius: 0.65rem;
      background: #fef9c3;
      color: #92400e;
      border: 1px solid #fcd34d;
      font-size: 0.82rem;
      line-height: 1.35;
    }

    .refuerzo-bloque {
      margin-top: 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    /* ============================================
       PILARES DISPLAY
       ============================================ */
    .pilares-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.85rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 0.82rem;
      font-weight: 600;
      min-width: 52px;
    }

    /* ============================================
       BOTONES
       ============================================ */
    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      font-size: 0.82rem;
      font-weight: 600;
      padding: 0.45rem 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.08s, box-shadow 0.08s, background 0.12s;
    }

    button.primary {
      background: var(--blue-main);
      color: #fff;
      box-shadow: 0 10px 26px rgba(0, 84, 166, 0.5);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(0, 84, 166, 0.6);
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.secondary:hover {
      background: #d1d5db;
    }

    /* ============================================
       DIAGRAMA SVG
       ============================================ */
    .diagram-wrapper {
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 0.45rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    svg {
      max-width: 100%;
      height: auto;
    }

    .diagram-caption {
      font-size: 0.74rem;
      color: var(--text-soft);
      margin-top: 0.35rem;
    }

    /* ============================================
       SUMMARY BLOCKS
       ============================================ */
    .summary-block {
      border-radius: 0.6rem;
      border: 1px dashed #cbd5f1;
      background: #f8fafc;
      padding: 0.45rem 0.6rem;
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 0.15rem;
    }

    .summary-block h3 {
      margin: 0 0 0.25rem;
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--blue-dark);
    }

    .summary-list {
      margin: 0;
      padding-left: 1rem;
    }

    .summary-list li {
      margin-bottom: 0.15rem;
    }

    .budget-info {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.25rem;
      font-size: 0.78rem;
      margin-bottom: 0.45rem;
    }

    .budget-info-item span.label {
      color: var(--text-soft);
      font-weight: 500;
    }

    .budget-info-item span.value {
      font-weight: 600;
    }

    .ref-line {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-top: 0.1rem;
    }

    /* ============================================
       TABLAS
       ============================================ */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 0.35rem;
    }

    th,
    td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
      background: #f9fafb;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    /* ============================================
       DOCUMENTOS INFORMES
       ============================================ */
    .documento-pdf {
      display: none;
    }

    .documento-preview {
      margin-top: 0.5rem;
    }

    /* ============================================
       FOOTER
       ============================================ */
    footer {
      margin-top: 1rem;
      padding: 0.6rem 1.5rem 0.8rem;
      font-size: 0.72rem;
      color: var(--text-soft);
      text-align: center;
    }


    /* Bloqueo de todo el contenido bajo los datos comerciales */
    #panel-todo.bloqueado {
      opacity: 0.38;
      pointer-events: none;
      filter: grayscale(0.25);
      transition: opacity 0.3s, filter 0.3s;
    }
    #panel-todo {
      transition: opacity 0.3s, filter 0.3s;
    }
    /* ============================================
       CLASES DE UTILIDAD
       ============================================ */
    .solo-web {
      display: block;
    }

    /* ============================================
       INFORMES ECON√ìMICOS - ANCHO COMPLETO
       ============================================ */
    .informes-fullwidth {
      max-width: 1200px;
      margin: 2rem auto 0;
      padding: 0 1.5rem;
      animation: slideUpFade 0.5s ease-out;
    }

    @media (max-width: 960px) {
      .informes-fullwidth {
        padding: 0 0.9rem;
      }
    }

    /* Animaci√≥n de entrada suave */
    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header sticky del selector de documentos */
    .informes-sticky-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--card-bg);
      padding: 1rem 1.25rem 0.75rem;
      margin: -1.1rem -1.25rem 0.75rem;
      border-bottom: 1px solid var(--border-subtle);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      border-radius: var(--radius) var(--radius) 0 0;
    }

    /* Optimizaci√≥n de tablas para ancho completo */
    .informes-fullwidth table {
      font-size: 0.85rem;
      table-layout: auto;
    }

    .informes-fullwidth th {
      font-size: 0.75rem;
      padding: 0.5rem 0.6rem;
      white-space: nowrap;
    }

    .informes-fullwidth td {
      padding: 0.5rem 0.6rem;
    }

    /* Ajuste espec√≠fico para el informe de material (9 columnas) */
    #doc-material table th:nth-child(3),
    #doc-material table td:nth-child(3) {
      min-width: 200px; /* Descripci√≥n m√°s ancha */
    }

    #doc-material table th:nth-child(6),
    #doc-material table td:nth-child(6) {
      text-align: center; /* Long. barra centrada */
    }

    #doc-material table th:nth-child(7),
    #doc-material table td:nth-child(7) {
      text-align: center; /* N¬∫ barras centrada */
    }

    #doc-material table th:nth-child(8),
    #doc-material table td:nth-child(8),
    #doc-material table th:nth-child(9),
    #doc-material table td:nth-child(9) {
      text-align: right; /* Precios alineados a derecha */
    }

    /* Totales destacados */
    .informes-fullwidth .summary-block {
      margin-top: 1rem;
      padding: 0.8rem 1rem;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
      border: 1px solid var(--border-subtle);
    }

    .informes-fullwidth .summary-block strong {
      font-size: 1.05rem;
      color: var(--blue-dark);
    }

    /* ============================================
       MEDIA QUERIES PARA IMPRESI√ìN
       ============================================ */
    @media print {
      .card,
      .summary-block,
      .diagram-wrapper {
        page-break-inside: avoid;
      }

      tr,
      th,
      td {
        page-break-inside: avoid;
      }
    }

    /* ============================================
       ESTILOS PDF - FORMATO REFERENCIA
       ============================================ */

    .pdf-documento-multipagina {
      font-family: "Calibri", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: transparent;
      padding: 0;
    }

    .pdf-page-a4 {
      width: 210mm;
      min-height: 297mm;
      padding: 15mm 18mm;
      margin: 0 auto 20mm;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      position: relative;
      page-break-after: always;
      display: flex;
      flex-direction: column;
    }

    .pdf-page-a4:last-child {
      page-break-after: auto;
      margin-bottom: 0;
    }

    .pdf-header-ref {
      margin-bottom: 8mm;
    }

    .pdf-header-ref-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 3mm;
    }

    .pdf-logo-ref {
      width: 30mm;
      height: auto;
      display: block;
    }

    .pdf-logo-ref-placeholder {
      width: 30mm;
      height: 15mm;
      background: #e5e7eb;
      border-radius: 4px;
    }

    .pdf-header-ref-centro {
      flex: 1;
      margin-left: 8mm;
    }

    .pdf-empresa-ref {
      font-size: 14pt;
      font-weight: 700;
      color: #0369a1;
      letter-spacing: 0.1em;
      margin-bottom: 1mm;
    }

    .pdf-subtitulo-ref {
      font-size: 9pt;
      color: #6b7280;
      letter-spacing: 0.05em;
    }

    .pdf-header-ref-right {
      font-size: 10pt;
      color: #1f2937;
      text-align: right;
    }

    .pdf-divider-ref {
      height: 1px;
      background: #d1d5db;
    }

    .pdf-resumen-config-ref {
      margin-bottom: 6mm;
    }

    .pdf-resumen-header-ref {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 3mm;
    }

    .pdf-titulo-seccion-ref {
      font-size: 13pt;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 2mm 0;
    }

    .pdf-ref-presupuesto {
      font-size: 9pt;
      color: #6b7280;
    }

    .pdf-badge-previo {
      background: #dbeafe;
      color: #1e40af;
      font-size: 8pt;
      font-weight: 600;
      padding: 2mm 4mm;
      border-radius: 4px;
      letter-spacing: 0.05em;
    }

    .pdf-datos-comerciales-ref {
      display: flex;
      gap: 8mm;
      font-size: 9pt;
      margin-bottom: 4mm;
      color: #374151;
    }

    .pdf-recuadro-azul {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 4px;
      padding: 4mm;
    }

    .pdf-recuadro-titulo {
      font-size: 10pt;
      font-weight: 600;
      color: #1e40af;
      margin: 0 0 2mm 0;
    }

    .pdf-lista-datos {
      margin: 0;
      padding-left: 5mm;
      font-size: 9pt;
      color: #374151;
      list-style-type: disc;
    }

    .pdf-lista-datos li {
      margin-bottom: 1mm;
      line-height: 1.4;
    }

    .pdf-bloque-esquema-ref {
      margin-bottom: 6mm;
    }

    .pdf-esquema-contenedor-ref {
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 4mm;
      background: white;
      text-align: center;
      min-height: 50mm;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pdf-esquema-placeholder {
      color: #9ca3af;
      font-style: italic;
      font-size: 9pt;
    }

    .pdf-content-a4 {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 10mm;
    }

    .pdf-bloque-tabla {
      margin-bottom: 5mm;
      flex: 1;
    }

    .pdf-titulo-tabla-ref {
      font-size: 12pt;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 3mm 0;
    }

    .pdf-subtitulo-tabla-ref {
      font-size: 9pt;
      color: #6b7280;
      margin-bottom: 2mm;
    }

    .pdf-tabla-materiales {
      width: 100%;
      border-collapse: collapse;
      font-size: 8pt;
    }

    .pdf-tabla-materiales thead {
      background: #f3f4f6;
    }

    .pdf-tabla-materiales th {
      padding: 2mm 1.5mm;
      text-align: left;
      font-weight: 600;
      color: #1f2937;
      border: 1px solid #d1d5db;
      font-size: 8pt;
    }

    .pdf-tabla-materiales td {
      padding: 1.5mm 1.5mm;
      border: 1px solid #e5e7eb;
      color: #374151;
    }

    .pdf-tabla-materiales tr:nth-child(even) {
      background: #fafafa;
    }

    .pdf-tabla-materiales tr {
      page-break-inside: avoid;
    }

    .pdf-bloque-totales {
      margin-top: 5mm;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 4mm;
    }

    .pdf-totales-titulo {
      font-size: 11pt;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 3mm 0;
    }

    .pdf-total-fila {
      display: flex;
      justify-content: space-between;
      padding: 1.5mm 0;
      font-size: 9pt;
      border-bottom: 1px solid #e5e7eb;
    }

    .pdf-total-fila span:first-child {
      color: #6b7280;
    }

    .pdf-total-fila span:last-child {
      font-weight: 600;
      color: #1f2937;
    }

    .pdf-total-destacado {
      border-top: 2px solid #0369a1;
      border-bottom: 2px solid #0369a1;
      margin-top: 2mm;
      padding: 2mm 0;
      background: white;
    }

    .pdf-total-destacado span {
      font-weight: 700;
      color: #0369a1 !important;
    }

    .pdf-total-destacado span:last-child {
      font-size: 11pt;
    }

    .pdf-footer-a4 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 3mm;
      border-top: 1px solid #d1d5db;
      font-size: 8pt;
      color: #6b7280;
      margin-top: auto;
    }

    .pdf-footer-izq {
      font-weight: 600;
    }

    .pdf-footer-der {
      font-style: italic;
    }

    @media print {
      .pdf-documento-multipagina {
        background: white;
        padding: 0;
      }
      
      .pdf-page-a4 {
        margin: 0;
        box-shadow: none;
        page-break-after: always;
      }
      
      .pdf-page-a4:last-child {
        page-break-after: auto;
      }
      
      .pdf-tabla-materiales thead {
        display: table-header-group;
      }
      
      .pdf-resumen-config-ref,
      .pdf-bloque-esquema-ref,
      .pdf-bloque-totales {
        page-break-inside: avoid;
      }
    }

    /* ============================================
       MODAL DE VISTA PREVIA PDF
       ============================================ */
    .pdf-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
    }

    .pdf-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
    }

    .pdf-modal-container {
      position: relative;
      width: 90%;
      max-width: 900px;
      height: 90%;
      margin: 2.5% auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .pdf-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .pdf-modal-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      flex: 1;
      min-width: 200px;
    }

    .pdf-zoom-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f9fafb;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .pdf-zoom-btn {
      background: white;
      border: 1px solid #d1d5db;
      color: #374151;
      cursor: pointer;
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      min-width: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pdf-zoom-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .pdf-zoom-btn:active {
      transform: scale(0.95);
    }

    .pdf-zoom-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pdf-zoom-display {
      min-width: 55px;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: #0054a6;
    }

    .pdf-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .pdf-modal-close:hover {
      background: #f3f4f6;
      color: #1f2937;
    }

    .pdf-modal-body {
      flex: 1;
      overflow: auto;
      padding: 0;
      background: #9ca3af;
      position: relative;
    }

    .pdf-preview-wrapper {
      padding: 20px;
      min-width: min-content;
      min-height: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .pdf-preview-content {
      transform-origin: top center;
      transition: transform 0.2s ease-out;
    }

    .pdf-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      flex-wrap: wrap;
    }

    /* Responsive para m√≥vil */
    @media (max-width: 768px) {
      .pdf-modal-container {
        width: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0;
      }

      .pdf-modal-header {
        padding: 1rem;
      }

      .pdf-modal-title {
        font-size: 1rem;
        min-width: auto;
      }

      .pdf-zoom-controls {
        order: 3;
        width: 100%;
        justify-content: center;
      }

      .pdf-modal-footer {
        padding: 1rem;
      }
    }

    /* ============================================
       PANTALLA DE ACCESO (v-screen)
       ============================================ */
    #v-screen {
      position: fixed;
      inset: 0;
      z-index: 99999;
      background: linear-gradient(135deg, #001f4d 0%, #003b7a 45%, #0054a6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .v-card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 1.6rem;
      padding: 2.8rem 3rem 2.4rem;
      width: 100%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 32px 80px rgba(0,0,0,0.45);
    }

    .v-logo {
      width: 110px;
      height: auto;
      margin: 0 auto 1.4rem;
      display: block;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
    }

    .v-brand {
      font-size: 1.35rem;
      font-weight: 800;
      letter-spacing: 0.12em;
      color: #ffffff;
      margin: 0 0 0.2rem;
      text-transform: uppercase;
    }

    .v-sub {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin: 0 0 2rem;
    }

    .v-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      margin: 0 0 1.8rem;
    }

    .v-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: rgba(255,255,255,0.45);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin: 0 0 0.6rem;
      display: block;
    }

    #v-field {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #ffffff;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      text-align: center;
      outline: none;
      transition: border-color 0.2s, background 0.2s;
      -webkit-text-security: disc;
    }

    #v-field:focus {
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.12);
    }

    #v-field::placeholder {
      color: rgba(255,255,255,0.25);
      letter-spacing: 0.05em;
      font-size: 0.85rem;
    }

    #v-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 0.8rem;
      border-radius: 0.75rem;
      border: none;
      background: linear-gradient(135deg, #2563eb, #0054a6);
      color: #fff;
      font-size: 0.92rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,84,166,0.45);
      transition: transform 0.1s, box-shadow 0.15s;
    }

    #v-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 32px rgba(0,84,166,0.6);
    }

    #v-btn:active { transform: scale(0.98); }

    #v-img-err {
      display: none;
      width: 180px;
      height: auto;
      margin: 1.1rem auto 0;
    }

    .v-footer {
      margin-top: 2rem;
      font-size: 0.68rem;
      color: rgba(255,255,255,0.2);
      letter-spacing: 0.05em;
    }

    @keyframes vShake {
      0%,100% { transform: translateX(0); }
      15%      { transform: translateX(-10px); }
      30%      { transform: translateX(9px); }
      45%      { transform: translateX(-7px); }
      60%      { transform: translateX(6px); }
      75%      { transform: translateX(-4px); }
      90%      { transform: translateX(3px); }
    }


    /* Bot√≥n de instalaci√≥n PWA */
    #v-install-btn {
      display: none;
      margin-top: 0.8rem;
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.85);
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: background 0.2s;
    }
    #v-install-btn:hover {
      background: rgba(255,255,255,0.14);
    }

    @media (max-width: 480px) {
      .v-card { padding: 2rem 1.4rem 1.8rem; margin: 1rem; }
    }

  </style>
</head>

<body>

  <!-- Pantalla de acceso corporativo -->
  <div id="v-screen">
    <div class="v-card">
      <img src="./js/logo.png" alt="" class="v-logo" onerror="this.style.display='none'" />
      <p class="v-brand">Aluminios Galisur</p>
      <p class="v-sub">Serie Doha Sun &nbsp;¬∑&nbsp; Tarifa 2026</p>
      <div class="v-divider"></div>
      <span class="v-label">Entrada corporativa</span>
      <input id="v-field" type="text" inputmode="numeric" autocomplete="off"
             spellcheck="false" placeholder="¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑" maxlength="12" />
      <button id="v-btn">Acceder</button>
      <button id="v-install-btn" style="display:block;">‚¨áÔ∏è &nbsp;Instalar en este dispositivo</button>
      <img id="v-img-err" src="./js/vidrio.png" alt="" draggable="false" />
      <p class="v-footer">Uso exclusivo para distribuidores autorizados</p>
    </div>
  </div>

  <div class="app" style="display:none;opacity:0;">
    <!-- ============================================
         CABECERA DE LA P√ÅGINA
         ============================================ -->
    <div class="page-title-block">
      <div class="title-row">
        <div>
          <h1>Presupuestador p√©rgola bioclim√°tica</h1>
          <p class="subtitle">Serie Doha Sun</p>
        </div>
        <div class="version-pill">
          <span class="version-dot"></span>
          <span id="versionLabel">Versi√≥n</span>
        </div>
      </div>
    </div>

    <!-- ============================================
         DATOS GENERALES DEL PRESUPUESTO
         ============================================ -->
    <div class="datos-presupuesto">
      <div class="datos-grid">
        <div class="field">
          <label for="comercial">Nombre comercial</label>
          <input type="text" id="comercial" placeholder="Ej.: Juan P√©rez" />
        </div>
        <div class="field">
          <label for="cliente">Cliente</label>
          <input type="text" id="cliente" placeholder="Ej.: Carpinter√≠a XYZ" />
        </div>
        <div class="field">
          <label for="refObra">Ref. obra</label>
          <input type="text" id="refObra" placeholder="Ej.: PERG-2025-001" />
        </div>
      </div>

      <!-- N√∫mero de presupuesto y botones globales -->
      <div id="presupuestoBadge" style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.75rem; justify-content: space-between; flex-wrap: wrap;">
        <span style="padding: 6px 12px; background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 6px; color: #1e1b4b; font-weight: 600; font-size: 0.9rem;">
          N¬∫ de presupuesto: <span id="refCode"></span>
        </span>
        <div style="display: flex; gap: 0.5rem;">
          <button class="secondary" id="btnRecalcular" type="button" style="padding: 0.4rem 0.8rem; font-size: 0.82rem;">üîÑ Limpiar</button>
          <button class="secondary" id="btnNuevoPresupuesto" type="button" style="padding: 0.4rem 0.8rem; font-size: 0.82rem;">‚ûï Nuevo</button>
        </div>
      </div>
    </div>

    <div id="panel-todo" class="bloqueado">
    <!-- ============================================
         LAYOUT PRINCIPAL: DOS COLUMNAS
         ============================================ -->
    <div class="layout">
      <!-- ====================================
           COLUMNA IZQUIERDA: ENTRADA DE DATOS
           ==================================== -->
      <div>
        <!-- TARJETA 1: Datos geom√©tricos -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="step-badge">1</span>
              Datos geom√©tricos y m√≥dulos
            </div>
            <span class="pill">Entrada</span>
          </div>

          <div class="grid grid-3">
            <div class="field">
              <label for="salida">Largo / salida [m]</label>
              <input id="salida" type="number" step="0.01" min="1.5" max="6.0" placeholder="Ej.: 4,00" />
              <div class="field-note">Largo √∫til de p√©rgola. M√≠nimo 1,50 m ¬∑ M√°ximo 6,00 m.</div>
              <div class="field-error" id="salidaError"></div>
            </div>
            <div class="field">
              <label for="ancho">Ancho p√©rgola [m]</label>
              <input id="ancho" type="number" step="0.01" min="1.5" placeholder="Ej.: 3,50" />
              <div class="field-note">Ancho en sentido de lamas. M√≠nimo 1,50 m. M√°x. 4,00 m por m√≥dulo.</div>
              <div class="field-error" id="anchoError"></div>
            </div>
            <div class="field">
              <label for="altura">Altura libre [m]</label>
              <input id="altura" type="number" step="0.01" min="2.0" max="2.8" placeholder="Ej.: 2,50" />
              <div class="field-note">Altura libre (m√°ximo 2,80 m).</div>
              <div class="field-error" id="alturaError"></div>
            </div>
          </div>

          <div class="note">
            <span class="note-icon">‚ÑπÔ∏è</span>
            <span><strong>Direcci√≥n de las lamas:</strong> siempre en la direcci√≥n del <strong>ancho</strong> de la p√©rgola.</span>
          </div>

          <div style="margin-top: 0.7rem;">
            <label class="field" style="margin-bottom:0.3rem;">M√≥dulos</label>
            <div class="pill-group" id="grupoModulos">
              <label class="pill-option">
                <input type="radio" name="numModulos" value="1" checked />
                <span>1 m√≥dulo</span>
              </label>
              <label class="pill-option">
                <input type="radio" name="numModulos" value="2" />
                <span>2 m√≥dulos</span>
              </label>
              <label class="pill-option">
                <input type="radio" name="numModulos" value="3" />
                <span>3 m√≥dulos</span>
              </label>
              <label class="pill-option">
                <input type="radio" name="numModulos" value="4" />
                <span>4 m√≥dulos</span>
              </label>
              <label class="pill-option">
                <input type="radio" name="numModulos" value="mas" />
                <span>M√°s de 4</span>
              </label>
            </div>
            <div id="campoModulosManual" style="display:none; margin-top:0.5rem;">
              <input id="modulos" type="number" min="5" step="1" placeholder="N√∫mero de m√≥dulos (5 o m√°s)"
                     style="max-width:220px;" />
              <div class="field-note">Introduce el n√∫mero exacto de m√≥dulos.</div>
            </div>
            <!-- checkbox oculto que mantiene compatibilidad con app.js -->
            <input type="checkbox" id="chkVariosModulos" style="display:none;" />
          </div>
        </section>

        <!-- TARJETA 2: Configuraci√≥n (Montaje + Automatizaci√≥n + Acabados) -->
        <section class="card" style="margin-top: 0.85rem;">
          <div class="card-header">
            <div class="card-title">
              <span class="step-badge">2</span>
              Configuraci√≥n
            </div>
            <span class="pill">Configuraci√≥n</span>
          </div>

          <!-- ============ BLOQUE 1: MONTAJE Y ESTRUCTURA ============ -->
          <div style="padding-bottom: 0.7rem; border-bottom: 1px solid var(--border-subtle);">
            <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--blue-dark); margin: 0 0 0.7rem 0;">Montaje y estructura</h4>
            
            <div class="grid grid-2">
              <div class="field">
                <label>Tipo de montaje</label>
                <div class="pill-group" id="grupoMontaje">
                  <label class="pill-option">
                    <input type="radio" name="montaje" value="pilares" checked />
                    <span>Sobre pilares</span>
                  </label>
                  <label class="pill-option">
                    <input type="radio" name="montaje" value="pared-ancho" />
                    <span>A pared ¬∑ sobre ancho</span>
                  </label>
                  <label class="pill-option">
                    <input type="radio" name="montaje" value="pared-largo" />
                    <span>A pared ¬∑ sobre largo</span>
                  </label>
                  <label class="pill-option">
                    <input type="radio" name="montaje" value="entre-paredes" />
                    <span>Entre paredes</span>
                  </label>
                </div>
                <div class="field-note" id="textoMontaje"></div>
                <div class="field-note" id="textoMontajeDetallado" style="display: none;"></div>
              </div>

              <div class="field">
                <!-- Campos condicionales: Posici√≥n de pared / Entre paredes -->
                <div class="field" id="campoPosicionPared" style="display: none;">
                  <label for="posicionPared">Posici√≥n de la pared</label>
                  <select id="posicionPared"></select>
                </div>
                <div class="field" id="campoEntreParedes" style="display: none;">
                  <label for="tipoEntreParedes">Paredes</label>
                  <select id="tipoEntreParedes">
                    <option value="laterales">Laterales</option>
                    <option value="frontales">Frontales</option>
                  </select>
                </div>
                
                <!-- Bloque de refuerzo - MOVIDO AQU√ç -->
                <div id="bloqueRefuerzo" class="refuerzo-bloque" style="display: none; margin-top: 0.7rem;">
                  <label class="inline-checkbox">
                    <input type="checkbox" id="chkPilaresRefuerzo" checked />
                    <span>Colocar pilares de apoyo</span>
                  </label>
                  <div class="aviso-amarillo" id="avisoRefuerzo" style="display: none;"></div>
                </div>
              </div>
            </div>

            <div class="warning" id="warning" style="display: none;"></div>

            <!-- N√∫mero de pilares calculado - Bloque separado y destacado -->
            <div style="margin-top: 0.7rem;">
              <label style="display: block; font-size: 0.8rem; color: var(--text-soft); margin-bottom: 0.4rem; font-weight: 600;">N¬∫ de pilares (calculado)</label>
              <div id="pilaresDisplay" class="pilares-pill" style="background: #f3f4f6; padding: 0.6rem; border-radius: 0.6rem; font-size: 1.2rem; font-weight: 700; color: var(--blue-dark); text-align: center; border: 2px solid #e5e7eb;">‚Äî</div>
              <div class="field-note" id="calibrePilaresDisplay" style="margin-top: 0.4rem; font-style: italic; color: var(--text-soft); text-align: center;">Calibre de los pilares: ‚Äî</div>
              <!-- Perfil opcional 7497 - junto al c√°lculo de pilares -->
              <div style="margin-top: 0.6rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85rem; color: var(--text-soft);">
                  <input type="checkbox" id="chkSuplementoFrontal7497" style="width: auto; margin: 0;">
                  <span>Suplemento frontal 7497</span>
                </label>
              </div>
            </div>
          </div>

          <!-- ============ BLOQUE 2: AUTOMATIZACI√ìN ============ -->
          <div style="padding: 0.7rem 0; border-bottom: 1px solid var(--border-subtle);">
            <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--blue-dark); margin: 0 0 0.7rem 0;">Automatizaci√≥n</h4>
            
            <div class="grid grid-2">
              <div class="field">
                <label>Configuraci√≥n de motores</label>
                <div class="pill-group" id="grupoModoMotor">
                  <label class="pill-option">
                    <input type="radio" name="modoMotor" value="todos-izquierda" checked />
                    <span id="labelMotorIzquierda">Motor a izquierda</span>
                  </label>
                  <label class="pill-option">
                    <input type="radio" name="modoMotor" value="todos-derecha" />
                    <span id="labelMotorDerecha">Motor a derecha</span>
                  </label>
                  <label class="pill-option" id="pillPersonalizado">
                    <input type="radio" name="modoMotor" value="personalizado" />
                    <span id="labelMotorPersonalizado">Personalizado por m√≥dulo</span>
                  </label>
                </div>
              </div>
              <div class="field">
                <label for="mando">Mando</label>
                <select id="mando">
                  <option value="con">Con mando</option>
                  <option value="sin">Sin mando</option>
                </select>
                
                <!-- Sensores opcionales - MOVIDO AQU√ç -->
                <div style="margin-top: 0.7rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-soft);">Sensores opcionales</label>
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="sensorLluvia" style="width: auto; margin: 0;">
                      <span>Sensor de lluvia</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="sensorViento" style="width: auto; margin: 0;">
                      <span>Sensor de viento</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="field" id="motorPorModuloWrapper" style="display: none; margin-top: 0.7rem;">
              <label>Motores por m√≥dulo</label>
              <div id="motorPorModuloContainer" class="grid grid-2"></div>
            </div>
          </div>

          <!-- ============ BLOQUE 3: ACABADOS ============ -->
          <div style="padding-top: 0.7rem;">
            <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--blue-dark); margin: 0 0 0.7rem 0;">Acabados</h4>
            
            <div class="field">
              <label>Colores de la p√©rgola</label>
              <div class="pill-group" id="grupoColorPergola">
                <label class="pill-option">
                  <input type="radio" name="colorModo" value="mono" checked />
                  <span>P√©rgola monocolor</span>
                </label>
                <label class="pill-option">
                  <input type="radio" name="colorModo" value="bicolor" />
                  <span>P√©rgola bicolor</span>
                </label>
              </div>

              <div class="grid grid-2" style="margin-top: 0.5rem;">
                <div class="field" id="campoColorGlobal">
                  <label for="colorGlobal">Acabado general</label>
                  <select id="colorGlobal">
                    <option value="blanco">Blanco</option>
                    <option value="textura">Textura</option>
                    <option value="color">Color</option>
                    <option value="anodizado">Anodizado</option>
                    <option value="nature">Nature</option>
                  </select>
                </div>
                <div class="field" id="campoColorLamas" style="display: none;">
                  <label for="colorLamas">Color lamas</label>
                  <select id="colorLamas">
                    <option value="blanco">Blanco</option>
                    <option value="textura">Textura</option>
                    <option value="color">Color</option>
                    <option value="anodizado">Anodizado</option>
                    <option value="nature">Nature</option>
                  </select>
                </div>
                <div class="field" id="campoColorPerimetro" style="display: none;">
                  <label for="colorPerimetro">Color per√≠metro</label>
                  <select id="colorPerimetro">
                    <option value="blanco">Blanco</option>
                    <option value="textura">Textura</option>
                    <option value="color">Color</option>
                    <option value="anodizado">Anodizado</option>
                    <option value="nature">Nature</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-2" style="margin-top: 0.5rem;">
                <div class="field" id="refAcabadoGlobalWrap">
                  <label for="refAcabadoGlobal">Referencia acabado general</label>
                  <input id="refAcabadoGlobal" type="text" placeholder="Ej.: RAL 9016" />
                </div>
                <div class="field" id="refAcabadoLamasWrap" style="display: none;">
                  <label for="refAcabadoLamas">Referencia acabado lamas</label>
                  <input id="refAcabadoLamas" type="text" placeholder="Ej.: RAL 7016" />
                </div>
                <div class="field" id="refAcabadoPerimetroWrap" style="display: none;">
                  <label for="refAcabadoPerimetro">Referencia acabado per√≠metro</label>
                  <input id="refAcabadoPerimetro" type="text" placeholder="Ej.: RAL 9010" />
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ====================================
           COLUMNA DERECHA: VISUALIZACI√ìN
           ==================================== -->
      <div>
        <!-- TARJETA 3: Esquema -->
        <section class="card solo-web">
          <div class="card-header">
            <div class="card-title">
              <span class="step-badge">3</span>
              Vista esquem√°tica de la p√©rgola
            </div>
          </div>

          <div class="diagram-wrapper">
            <svg id="pergolaSvg" viewBox="0 0 340 240"></svg>
          </div>
          <div class="diagram-caption" id="diagramCaption">
            Introduce largo, ancho y configuraci√≥n para ver el esquema.
          </div>

          <!-- Leyenda -->
          <div style="width: 100%; max-width: 520px; margin: 6px auto 0; font-size: 10px; color: #4b5563; line-height: 1.4;">
            <strong>Leyenda:</strong>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 3px;">
              <span><span style="color: #16a34a;">‚ñ†</span> Pilares estructurales</span>
              <span><span style="color: #facc15;">‚ñ†</span> Pilares de apoyo</span>
              <span><span style="color: #9ca3af;">‚ñ†</span> Pared existente</span>
              <span><span style="color: #f97316;">‚ñ†</span> Motor</span>
              <span>‚Üî Direcci√≥n de lamas</span>
            </div>
          </div>
        </section>

        <!-- TARJETA 4: Resumen de configuraci√≥n -->
        <section class="card" id="resumenCard" style="margin-top: 0.9rem;">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="step-badge">4</span>
                Resumen de configuraci√≥n
              </div>
            </div>
            <span class="pill">Previo</span>
          </div>

          <div id="budgetInfo" class="budget-info" style="display: none;">
            <div class="budget-info-item">
              <span class="label">Comercial: </span>
              <span class="value" id="biComercial"></span>
            </div>
            <div class="budget-info-item">
              <span class="label">Cliente: </span>
              <span class="value" id="biCliente"></span>
            </div>
            <div class="budget-info-item">
              <span class="label">Ref. obra: </span>
              <span class="value" id="biRefObra"></span>
            </div>
          </div>

          <div id="resumenConfig" class="summary-block">
            <h3>Datos principales</h3>
            <p>Introduce los datos para generar el resumen.</p>
          </div>

          <div id="resumenLamas" class="summary-block" style="margin-top: 0.45rem;">
            <h3>N√∫mero de lamas seg√∫n salida</h3>
            <p>Introduce la salida en metros para ver el n√∫mero orientativo de lamas.</p>
          </div>
        </section>

        <!-- Tabla de materiales oculta (para uso interno) -->
        <div style="display: none;">
          <table>
            <tbody id="tablaMateriales"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ============================================
         TARJETA 5: INFORMES ECON√ìMICOS (ANCHO COMPLETO)
         ============================================ -->
    <div class="informes-fullwidth">
      <section class="card solo-web" id="informesCard">
        <div class="informes-sticky-header">
          <div class="card-header" style="margin-bottom: 0;">
            <div class="card-title">
              <span class="step-badge">5</span>
              Informes econ√≥micos
            </div>
            <span class="pill">Informes</span>
          </div>

          <div class="note" style="margin-top: 0.75rem; margin-bottom: 0;">
            <div class="note-icon">üìÑ</div>
            <div style="display: flex; flex-direction: column; gap: 0.35rem;">
              <label style="font-weight: 600; color: var(--text-soft);">Documento a visualizar</label>
              <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                <select id="selectorDocumento" style="margin: 0; flex: 1; min-width: 160px;">
                  <option value="material">Informe de material</option>
                  <option value="peso">Peso y per√≠metros</option>
                  <option value="corte">Hoja de corte</option>
                </select>
                <button class="primary" id="btnVistaPreviaPDF" type="button" style="white-space: nowrap;">
                  üëÅÔ∏è Vista previa PDF
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenedores de documentos -->
        <div class="documento-preview">
            <!-- Informe de Material -->
            <div id="doc-material" class="documento-pdf">
              <h2 style="margin: 0 0 0.5rem;">Informe de material</h2>
              <div id="doc-material-resumen" class="summary-block"></div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Ref.</th>
                      <th>Descripci√≥n</th>
                      <th>Acabado</th>
                      <th>Ref. acabado</th>
                      <th>Long. barra (m)</th>
                      <th>N¬∫ barras / uds</th>
                      <th>Precio unit.</th>
                      <th>Importe</th>
                    </tr>
                  </thead>
                  <tbody id="doc-material-body"></tbody>
                </table>
              </div>
              <div id="doc-material-totales" class="summary-block"></div>
            </div>

            <!-- Peso y Per√≠metros -->
            <div id="doc-peso" class="documento-pdf">
              <h2 style="margin: 0 0 0.5rem;">Peso y per√≠metros</h2>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Ref.</th>
                      <th>Descripci√≥n</th>
                      <th>Peso total (kg)</th>
                      <th>Per√≠metro total (mm)</th>
                    </tr>
                  </thead>
                  <tbody id="doc-peso-body"></tbody>
                </table>
              </div>
            </div>

            <!-- Hoja de Corte -->
            <div id="doc-corte" class="documento-pdf">
              <h2 style="margin: 0 0 0.5rem;">Hoja de corte</h2>
              <div id="doc-corte-body" class="table-wrapper"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
    </div><!-- /panel-todo -->

    <!-- ============================================
         MODAL DE VISTA PREVIA PDF
         ============================================ -->
    <div id="pdfPreviewModal" class="pdf-modal" style="display: none;">
      <div class="pdf-modal-overlay"></div>
      <div class="pdf-modal-container">
        <div class="pdf-modal-header">
          <h2 class="pdf-modal-title">Vista previa del documento</h2>
          <div class="pdf-zoom-controls">
            <button class="pdf-zoom-btn" id="btnZoomOut" title="Reducir zoom">‚àí</button>
            <span class="pdf-zoom-display" id="zoomDisplay">100%</span>
            <button class="pdf-zoom-btn" id="btnZoomIn" title="Ampliar zoom">+</button>
            <button class="pdf-zoom-btn" id="btnZoomFit" title="Ajustar a pantalla">‚ä°</button>
            <button class="pdf-zoom-btn" id="btnZoomReset" title="Tama√±o real">1:1</button>
          </div>
          <button class="pdf-modal-close" id="btnCerrarModal">‚úï</button>
        </div>
        <div class="pdf-modal-body" id="pdfModalBody">
          <div class="pdf-preview-wrapper">
            <div id="pdfPreviewContent" class="pdf-preview-content"></div>
          </div>
        </div>
        <div class="pdf-modal-footer">
          <button class="secondary" id="btnCerrarModalFooter">Cerrar</button>
          <button class="secondary" id="btnCompartirDesdeModal">üì§ Compartir</button>
          <button class="primary" id="btnDescargarDesdeModal">üì• Descargar PDF</button>
        </div>
      </div>
    </div>

    <!-- ============================================
         FOOTER
         ============================================ -->
    <footer>
      Aluminios Galisur ¬∑ Presupuestador interno serie Doha Sun.
    </footer>
  </div>

  <!-- ============================================
       SCRIPT PRINCIPAL
       ============================================ -->
  <script type="module" src="./js/main.js"></script>
  <script src="./js/vidrio.js"></script>

  <script>
    // Registro del service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }

    let _deferredPrompt = null;

    // Capturar el evento ANTES de que cargue el DOM
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      _deferredPrompt = e;
      const btn = document.getElementById('v-install-btn');
      if (btn) btn.style.display = 'block';
    });

    window.addEventListener('appinstalled', () => {
      _deferredPrompt = null;
      const btn = document.getElementById('v-install-btn');
      if (btn) btn.style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('v-install-btn');
      if (!btn) return;

      // Si ya est√° instalada como PWA, ocultar bot√≥n
      if (window.matchMedia('(display-mode: standalone)').matches) {
        btn.style.display = 'none';
        return;
      }

      // Si el evento ya hab√≠a llegado antes del DOMContentLoaded, mostrar bot√≥n
      if (_deferredPrompt) btn.style.display = 'block';

      btn.addEventListener('click', async () => {
        if (!_deferredPrompt) {
          // Fallback: instrucciones manuales
          alert('Para instalar:\n‚Ä¢ Chrome/Edge PC: men√∫ ‚ãÆ ‚Üí Instalar aplicaci√≥n\n‚Ä¢ Android: men√∫ ‚ãÆ ‚Üí A√±adir a pantalla de inicio\n‚Ä¢ iPhone/iPad: bot√≥n compartir ‚Üí A√±adir a inicio');
          return;
        }
        _deferredPrompt.prompt();
        const { outcome } = await _deferredPrompt.userChoice;
        if (outcome === 'accepted') btn.style.display = 'none';
        _deferredPrompt = null;
      });
    });
  </script>
</body>

</html>